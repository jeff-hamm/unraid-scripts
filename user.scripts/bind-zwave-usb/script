#!/bin/bash
# Bind Zooz 800 Z-Wave Stick to cdc_acm driver on boot
# This ensures /dev/ttyACM0 and /dev/zwave are created

# Load cdc_acm module if not already loaded
modprobe cdc_acm 2>/dev/null

# Wait for USB device to be detected
sleep 3

# Check if device exists
if lsusb -d 1a86:55d4 >/dev/null 2>&1; then
    echo "Zooz Z-Wave stick detected"
    
    # Bind to cdc_acm if not already bound
    if [ ! -e /dev/ttyACM0 ]; then
        echo "Binding to cdc_acm driver..."
        echo "3-1.3:1.0" > /sys/bus/usb/drivers/cdc_acm/bind 2>/dev/null || true
        sleep 2
    fi
    
    # Reload udev rules to create symlink
    udevadm control --reload-rules
    udevadm trigger --subsystem-match=tty
    
    # Verify
    if [ -e /dev/zwave ]; then
        echo "✓ Z-Wave device ready at /dev/zwave -> /dev/ttyACM0"
        ls -l /dev/zwave /dev/ttyACM0
    else
        echo "✗ Failed to create /dev/zwave"
    fi
else
    echo "✗ Zooz Z-Wave stick not detected (1a86:55d4)"
    echo "Available USB devices:"
    lsusb | grep -i "zwave\|1a86"
fi
