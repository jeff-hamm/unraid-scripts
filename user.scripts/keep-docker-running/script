#!/bin/bash
# Script to prevent Docker from stopping when array stops
# This patches the array stop process to skip Docker shutdown

# Backup original rc.docker if not already backed up
if [ ! -f /etc/rc.d/rc.docker.original ]; then
    cp /etc/rc.d/rc.docker /etc/rc.d/rc.docker.original
fi

# Create a wrapper that ignores stop commands from array
cat > /etc/rc.d/rc.docker.wrapper << 'EOF'
#!/bin/bash
# Wrapper to prevent array from stopping Docker

# Source the original rc.docker functions
ORIGINAL_SCRIPT="/etc/rc.d/rc.docker.original"

# Check if this is being called during array stop
# by checking the calling process
CALLER=$(ps -o comm= $PPID)

case "$1" in
'stop'|'restart')
  # If called from emhttp/mdcmd (array operations), skip Docker stop
  if [[ "$CALLER" == "emhttp" ]] || [[ "$CALLER" == "mdcmd" ]] || pgrep -f "mdcmd stop" > /tmp/mdcmd.check; then
    logger "Array is stopping but keeping Docker running (cache pool independent)"
    exit 0
  else
    # Otherwise, allow normal Docker stop (manual or system shutdown)
    exec $ORIGINAL_SCRIPT "$@"
  fi
  ;;
*)
  # Pass through all other commands
  exec $ORIGINAL_SCRIPT "$@"
  ;;
esac
EOF

chmod +x /etc/rc.d/rc.docker.wrapper

# Replace rc.docker with our wrapper
cp /etc/rc.d/rc.docker.wrapper /etc/rc.d/rc.docker

echo "Docker will now stay running when array stops"
echo "Docker runs on: $(docker info 2>&1 | grep 'Docker Root Dir')"
echo ""
echo "To revert: cp /etc/rc.d/rc.docker.original /etc/rc.d/rc.docker"
