#!/bin/bash
# Keep VMs running when array stops
# VMs stored on cache pool don't need to stop with the array

# Backup original rc.libvirt if not already backed up
if [ ! -f /etc/rc.d/rc.libvirt.original ]; then
    cp -p /etc/rc.d/rc.libvirt /etc/rc.d/rc.libvirt.original
    logger "Backed up original rc.libvirt"
fi

# Check if already patched
if grep -q "# PATCHED: Keep VMs running" /etc/rc.d/rc.libvirt; then
    echo "VMs are already configured to stay running during array stop"
    exit 0
fi

# Create a patched version
cat > /tmp/rc.libvirt.patched << 'VMPATCH'
#!/bin/bash
# PATCHED: Keep VMs running when array stops (VMs on cache pool)

# Check if this is an array-stop operation
PARENT_CMD=$(ps -o args= $PPID | head -1)
if [[ "$1" == "stop" ]] && [[ "$PARENT_CMD" =~ (mdcmd|emhttp|array) ]]; then
    logger "Array stopping but keeping VMs running (cache pool independent)"
    echo "VMs staying active - stored on cache pool, not array"
    exit 0
fi

# Otherwise, source and run the original script
source /etc/rc.d/rc.libvirt.original "$@"
VMPATCH

# Apply the patch
cp /tmp/rc.libvirt.patched /etc/rc.d/rc.libvirt
chmod +x /etc/rc.d/rc.libvirt

logger "VMs configured to stay running when array stops"
echo "âœ“ VMs will now stay running when you stop the array"
echo "  VMs should be stored on: /mnt/pool (cache)"
echo ""
echo "To revert: cp /etc/rc.d/rc.libvirt.original /etc/rc.d/rc.libvirt"
