#compdef dc

# Completion for dc (smart docker-compose wrapper)

_dc() {
    local PHOME="${PHOME:-/mnt/pool/appdata/home}"
    source "${PHOME}/.conf/dc-projects.conf" 2>/dev/null || return 1
    
    local -a docker_compose_commands=(
        'attach:Attach to a running container'
        'build:Build or rebuild services'
        'config:Parse and render compose file'
        'create:Create containers'
        'down:Stop and remove containers'
        'exec:Execute command in container'
        'images:List images'
        'kill:Force stop containers'
        'logs:View container logs'
        'ls:List running projects'
        'pause:Pause services'
        'ps:List containers'
        'pull:Pull images'
        'push:Push images'
        'restart:Restart containers'
        'rm:Remove stopped containers'
        'run:Run one-off command'
        'start:Start services'
        'stop:Stop services'
        'top:Display running processes'
        'unpause:Unpause services'
        'up:Create and start containers'
        'version:Show version'
    )
    
    case $CURRENT in
        2)
            _describe -t commands 'command' docker_compose_commands
            ;;
        3)
            # Projects
            local -a projects
            for p in ${(k)DC_PROJECTS}; do
                projects+=("$p")
            done
            
            # Services - deduplicated, show parent project
            local -a services
            local -A seen
            for p in ${(k)DC_PROJECT_SERVICES}; do
                for s in ${=DC_PROJECT_SERVICES[$p]}; do
                    if [[ -z "${seen[$s]}" ]]; then
                        seen[$s]=1
                        services+=("$s:($p)")
                    fi
                done
            done
            
            _describe -t projects 'project' projects
            _describe -t services 'service' services
            ;;
        *)
            # After project/service, offer services from that project
            local target="${words[3]}"
            local project=""
            
            if [[ -n "${DC_PROJECTS[$target]}" ]]; then
                project="$target"
            else
                for p in ${(k)DC_PROJECT_SERVICES}; do
                    if [[ " ${DC_PROJECT_SERVICES[$p]} " == *" $target "* ]]; then
                        project="$p"
                        break
                    fi
                done
            fi
            
            if [[ -n "$project" && -n "${DC_PROJECT_SERVICES[$project]}" ]]; then
                local -a svcs
                for s in ${=DC_PROJECT_SERVICES[$project]}; do
                    svcs+=("$s")
                done
                _describe -t services 'service' svcs
            fi
            ;;
    esac
}

_dc "$@"
