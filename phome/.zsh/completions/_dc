#compdef dc

# Completion for dc (smart docker-compose wrapper)

_dc_completion() {
    # Load project mappings from config
    local PHOME="${PHOME:-/mnt/pool/appdata/home}"
    source "${PHOME}/.conf/dc-projects.conf" 2>/dev/null || return 1
    
    # Build completion list from DC_PROJECTS
    local -a projects
    for project in ${(k)DC_PROJECTS}; do
        projects+=("$project:Docker compose project")
    done
    
    # Build service names from all projects
    local -a services
    if (( CURRENT == 3 )); then
        for project in ${(k)DC_PROJECT_SERVICES}; do
            local project_services=(${=DC_PROJECT_SERVICES[$project]})
            for service in $project_services; do
                services+=("$service:Service in $project")
            done
        done
    fi
    
    # Build container names from running containers (only those in our projects)
    local -a containers
    if (( CURRENT == 3 )); then
        # Get containers that belong to our compose projects
        for project in ${(k)DC_PROJECTS}; do
            local project_containers=($(docker ps --filter "label=com.docker.compose.project=$project" --format '{{.Names}}' 2>/dev/null))
            for container in $project_containers; do
                containers+=("$container:Container in $project")
            done
        done
    fi
    
    local -a docker_compose_commands
    docker_compose_commands=(
        'attach:Attach local standard input, output, and error streams to a service'\''s running container'
        'build:Build or rebuild services'
        'commit:Create a new image from a service container'\''s changes'
        'config:Parse, resolve and render compose file in canonical format'
        'cp:Copy files/folders between a service container and the local filesystem'
        'create:Creates containers for a service'
        'down:Stop and remove containers, networks'
        'events:Receive real time events from containers'
        'exec:Execute a command in a running container'
        'export:Export a service container'\''s filesystem as a tar archive'
        'images:List images used by the created containers'
        'kill:Force stop service containers'
        'logs:View output from containers'
        'ls:List running compose projects'
        'pause:Pause services'
        'port:Print the public port for a port binding'
        'ps:List containers'
        'publish:Publish compose application'
        'pull:Pull service images'
        'push:Push service images'
        'restart:Restart service containers'
        'rm:Removes stopped service containers'
        'run:Run a one-off command on a service'
        'scale:Scale services'
        'start:Start services'
        'stats:Display a live stream of container(s) resource usage statistics'
        'stop:Stop services'
        'top:Display the running processes'
        'unpause:Unpause services'
        'up:Create and start containers', service names, and container names
        if [[ ${#containers[@]} -gt 0 ]]; then
            _describe 'project, service, or container' projects services containers
        else
            _describe 'project or service' projects serviceservice and rebuild/refresh containers when files are updated'
    )
    
    if (( CURRENT == 2 )); then
        # First argument: offer docker-compose commands
        _describe 'docker-compose command' docker_compose_commands
    elif (( CURRENT == 3 )); then
        # Second argument: offer project names AND container names
        if [[ ${#containers[@]} -gt 0 ]]; then
            _describe 'project or container' projects containers
        else
            _describe 'project' projects
        fi
    elif (( CURRENT >= 4 )); then
        # Additional arguments: offer services for the selected project
        local project="${words[3]}"
        if [[ -n "${DC_PROJECT_SERVICES[$project]}" ]]; then
            local -a services
            for service in ${=DC_PROJECT_SERVICES[$project]}; do
                services+=("$service")
            done
            _describe 'service' services
        fi
    fi
}

_dc_completion "$@"
