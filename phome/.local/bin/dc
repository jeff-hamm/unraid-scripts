#!/usr/bin/env zsh
# @desc Docker compose wrapper with project shortcuts
# Smart docker-compose wrapper with project, container, or service name detection
# Usage: dc <command> <project-or-container-or-service>  - finds and uses correct docker-compose.yml
#        dc <command>                                     - pass through to docker-compose in current directory

# Load project mappings from config
PHOME="${PHOME:-/mnt/pool/appdata/home}"
source "${PHOME}/.conf/dc-projects.conf" 2>/dev/null || {
    echo "Error: Could not load dc-projects.conf" >&2
    return 1
}

# Function to find project by service name
_find_project_by_service() {
    local service_name="$1"
    
    # Search through DC_PROJECT_SERVICES to find which project has this service
    for project in ${(k)DC_PROJECT_SERVICES}; do
        local services=(${=DC_PROJECT_SERVICES[$project]})
        if (( ${services[(I)$service_name]} )); then
            echo "$project"
            return 0
        fi
    done
    
    return 1
}

# Function to find project by container name
_find_project_by_container() {
    local container_name="$1"
    local found_projects=()
    
    # Get the compose project label from the container
    local project_label=$(docker inspect "$container_name" --format '{{index .Config.Labels "com.docker.compose.project"}}' 2>/dev/null)
    
    if [[ -n "$project_label" ]]; then
        # Find matching project in our config
        for project in ${(k)DC_PROJECTS}; do
            if [[ "$project" == "$project_label" ]]; then
                echo "$project"
                return 0
            fi
        done
    fi
    
    return 1
}

# Resolve name (could be project, container, or service)
_resolve_target() {
    local name="$1"
    
    # First check if it's a known project name
    if [[ -n "${DC_PROJECTS[$name]}" ]]; then
        echo "$name"
        return 0
    fi
    
    # Try to find it as a container name
    local project=$(_find_project_by_container "$name")
    if [[ -n "$project" ]]; then
        echo "$project"
        return 0
    fi
    
    # Try to find it as a service name
    project=$(_find_project_by_service "$name")
    if [[ -n "$project" ]]; then
        echo "$project"
        return 0
    fi
    
    return 1
}

# Main logic
if [[ -n "$2" ]]; then
    command="$1"
    target="$2"
    
    # Resolve target to project name
    project=$(_resolve_target "$target")
    
    if [[ -z "$project" ]]; then
        echo "Error: Unknown project, container, or service: $target" >&2
        echo "Known projects: ${(j:, :)${(ko)DC_PROJECTS}}" >&2
        return 1
    fi
    
    shift 2
    local original_dir="$PWD"
    cd "${DC_PROJECTS[$project]}" || {
        echo "Error: Directory not found: ${DC_PROJECTS[$project]}" >&2
        return 1
    }
    
    if [[ "$command" == "up" ]]; then
        docker-compose up -d "$@"
        local exit_code=$?
        [[ $exit_code -eq 0 ]] && docker-compose logs -f
    else
        docker-compose "$command" "$@"
    fi
    local exit_code=$?
    cd "$original_dir"
    return $exit_code
else
    # Pass through to docker-compose in current directory
    docker-compose "$@"
fi
