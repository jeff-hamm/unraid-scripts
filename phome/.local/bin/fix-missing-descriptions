#!/usr/bin/env zsh
# @desc Find scripts/functions missing @desc and use copilot to add them
# Scans ~/.local/bin and ~/.zsh/functions/ for files missing @desc comments
# Then invokes GitHub Copilot CLI to add the missing descriptions

set -euo pipefail

PHOME="${PHOME:-$HOME}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track files needing descriptions
typeset -a missing_scripts
typeset -a missing_functions

echo -e "${BLUE}Scanning for missing @desc comments...${NC}"
echo ""

# Check scripts in .local/bin
echo -e "${YELLOW}Checking scripts in ~/.local/bin:${NC}"
for script in "$PHOME/.local/bin/"*(N-*); do
    [[ -f "$script" ]] || continue
    local name="${script:t}"
    
    # Skip this script itself during development
    [[ "$name" == "fix-missing-descriptions" ]] && continue
    
    # Check first 10 lines for @desc
    local has_desc=false
    local line_num=0
    while IFS= read -r line && (( line_num++ < 10 )); do
        if [[ "$line" == *"# @desc "* ]]; then
            has_desc=true
            break
        fi
    done < "$script"
    
    if [[ "$has_desc" == "false" ]]; then
        echo -e "  ${RED}✗${NC} $name"
        missing_scripts+=("$script")
    else
        echo -e "  ${GREEN}✓${NC} $name"
    fi
done

echo ""

# Check function files in .zsh/functions/
echo -e "${YELLOW}Checking function files in ~/.zsh/functions/:${NC}"
for func_file in "$PHOME/.zsh/functions/"*.zsh(N); do
    [[ -f "$func_file" ]] || continue
    local name="${func_file:t}"
    
    # Count functions vs @desc comments
    local func_count=0
    local desc_count=0
    
    while IFS= read -r line; do
        if [[ "$line" == *"# @desc "* ]]; then
            (( desc_count++ ))
        elif [[ "$line" == [a-zA-Z_-]*"()"* ]]; then
            (( func_count++ ))
        fi
    done < "$func_file"
    
    if (( func_count > desc_count )); then
        echo -e "  ${RED}✗${NC} $name ($desc_count/$func_count functions have descriptions)"
        missing_functions+=("$func_file")
    else
        echo -e "  ${GREEN}✓${NC} $name ($desc_count/$func_count)"
    fi
done

echo ""

# Summary
local total_missing=$(( ${#missing_scripts[@]} + ${#missing_functions[@]} ))

if (( total_missing == 0 )); then
    echo -e "${GREEN}All scripts and functions have @desc comments!${NC}"
    exit 0
fi

echo -e "${YELLOW}Found $total_missing file(s) with missing descriptions.${NC}"
echo ""

# Check if copilot CLI is available
if ! command -v copilot &>/dev/null; then
    echo -e "${RED}Error: GitHub Copilot CLI not found.${NC}"
    echo "Please install it first: gh extension install github/gh-copilot"
    echo ""
    echo "Files needing descriptions:"
    for f in "${missing_scripts[@]}" "${missing_functions[@]}"; do
        echo "  $f"
    done
    exit 1
fi

# Ask user to proceed
echo -e "${BLUE}Would you like to use GitHub Copilot to add missing descriptions? [y/N]${NC}"
read -r response
if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

# Process each file
for script in "${missing_scripts[@]}"; do
    echo ""
    echo -e "${BLUE}Processing: ${script:t}${NC}"
    
    # Build prompt for copilot
    local prompt="Add a '# @desc ' comment (single line, concise description) right after the shebang line in this script. The @desc should briefly describe what the script does. Only output the modified file, no explanation.

File: ${script:t}
Content:
$(head -20 "$script")"

    echo "$prompt" | copilot suggest --target shell 2>/dev/null || {
        echo -e "${RED}Copilot failed for $script${NC}"
    }
done

for func_file in "${missing_functions[@]}"; do
    echo ""
    echo -e "${BLUE}Processing: ${func_file:t}${NC}"
    
    # Build prompt for copilot
    local prompt="Add '# @desc ' comments before each function that is missing one. Each @desc should be a single line with a concise description of what the function does. Only output the modified file, no explanation.

File: ${func_file:t}
Content:
$(cat "$func_file")"

    echo "$prompt" | copilot suggest --target shell 2>/dev/null || {
        echo -e "${RED}Copilot failed for $func_file${NC}"
    }
done

echo ""
echo -e "${YELLOW}Review the suggestions above and manually apply them.${NC}"
echo -e "${BLUE}To reload completions after fixing, run:${NC}"
echo "  autoload -U compinit && compinit"
