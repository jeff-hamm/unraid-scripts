#!/bin/bash
#
# Shell Startup Configuration
# Sets up symlinks, bashrc, profile.d, and environment variables
# Run at array startup via User Scripts, or source from /boot/config/go
#

echo "=== Shell Startup Configuration ==="
echo "Started: $(date)"

# Configuration
STARTUP_SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
APP_ROOT="/mnt/pool/appdata"
PERSISTENT_HOME="${APP_ROOT}/home"
SCRIPTS_DIR="$(dirname "$STARTUP_SCRIPT_DIR")"
set -a  # automatically export all variables
source ${SCRIPTS_DIR}/.env
set +a

# === SYMLINKS FOR PERSISTENT STORAGE ===
echo "Creating symlinks..."

# Bootstrap pln first (can't use pln to create itself)
cat > /usr/local/bin/pln << 'EOF'
#!/bin/bash
exec bash "/boot/config/plugins/user.scripts/scripts/shell_startup/pln.sh" "$@"
EOF
chmod +x /usr/local/bin/pln
echo "  /usr/local/bin/pln -> pln.sh (wrapper)"

# Use pln to apply all symlinks from config file
pln --apply
# === FIX /etc/profile ===
# Unraid's default profile has 'cd $HOME' which breaks VS Code Remote SSH
echo "Fixing /etc/profile..."
if grep -q '^cd \$HOME$' /etc/profile 2>/dev/null; then
    sed -i '/^cd \$HOME$/d' /etc/profile
    echo "  Removed 'cd \$HOME' from /etc/profile"
else
    echo "  /etc/profile already fixed"
fi

# === RUN BOOT.D SCRIPTS ===
BOOT_D="/mnt/pool/appdata/home/boot.d"
if [[ -d "$BOOT_D" ]]; then
    echo "Running boot.d scripts..."
    for script in "$BOOT_D"/*.sh; do
        if [[ -x "$script" ]]; then
            echo "  Running $(basename "$script")..."
            source "$script"
        fi
    done
fi

echo ""
echo "=== Shell Startup Complete ==="
echo "Finished: $(date)"
