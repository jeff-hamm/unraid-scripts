#!/bin/bash
#
# Shell Startup Configuration
# Sets up symlinks, bashrc, profile.d, and environment variables
# Run at array startup via User Scripts, or source from /boot/config/go
#

echo "=== Shell Startup Configuration ==="
echo "Started: $(date)"
# Configuration
STARTUP_SCRIPT="$(readlink -f "$0")"
export PHOME=${1:-${PHOME:-${APP_ROOT:-/mnt/pool/appdata}/home}}
echo "Using PHOME=$PHOME"
# === ENSURE GO FILE IS CONFIGURED ===
GO_FILE="/boot/config/go"
REQUIRED_LINE="bash /boot/config/plugins/user.scripts/scripts/shell_startup/script /mnt/pool/appdata/home"

if [[ -f "$GO_FILE" ]]; then
    # Check if the correct line exists
    if ! grep -qF "$REQUIRED_LINE" "$GO_FILE"; then
        echo "Adding shell_startup to $GO_FILE..."
        
        # Remove old 'source' line if it exists
        if grep -qF "source /boot/config/plugins/user.scripts/scripts/shell_startup/script" "$GO_FILE"; then
            sed -i '\|source /boot/config/plugins/user.scripts/scripts/shell_startup/script|d' "$GO_FILE"
            echo "  Removed old 'source' line"
        fi
        
        # Add the correct line
        cat >> "$GO_FILE" << EOF

# === SHELL STARTUP ===
# Run the shell_startup script for symlinks, bashrc, profile.d, env vars
# This also runs scripts from /mnt/pool/appdata/home/boot.d/ including:
#   - startup.sh (git config, /var/log resize)
#   - install-bluez.sh (Bluetooth stack for Home Assistant Docker)
$REQUIRED_LINE
EOF
        echo "  Added shell_startup to go file"
    else
        echo "Shell startup already configured in go file"
    fi
else
    echo "Warning: $GO_FILE not found"
fi

# === RUN BOOT.D SCRIPTS ===
BOOT_D="${PHOME}/boot.d"
if [[ -d "$BOOT_D" ]]; then
    echo "Running boot.d scripts..."
    for script in "$BOOT_D"/*.sh; do
        if [[ -x "$script" ]]; then
            echo "  Running $(basename "$script")..."
            source "$script" "$STARTUP_SCRIPT"
        fi
    done
fi

echo ""
echo "=== Shell Startup Complete ==="
echo "Finished: $(date)"
