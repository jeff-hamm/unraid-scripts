#!/bin/bash
#
# Shell Startup Configuration
# Sets up symlinks, bashrc, profile.d, and environment variables
# Run at array startup via User Scripts, or source from /boot/config/go
#

echo "=== Shell Startup Configuration ==="
echo "Started: $(date)"

# Configuration
APP_ROOT="/mnt/pool/appdata"
STARTUP_SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
SCRIPTS_DIR="$(dirname "$STARTUP_SCRIPT_DIR")"

# === SYMLINKS FOR PERSISTENT STORAGE ===
echo "Creating symlinks..."

# Define symlinks as "source,target" pairs
SYMLINKS=(
    "$APP_ROOT/home/.vscode-server,/root/.vscode-server"
    "$APP_ROOT/home/.docker,/root/.docker"
    "$APP_ROOT,/root/appdata"
    "/boot/config,/root/config"
    "$SCRIPTS_DIR,/root/scripts"
    "$SCRIPTS_DIR/ai_script_monitor/script,/usr/local/bin/ai-script-monitor"
    "$SCRIPTS_DIR/fix_disabled_disk/script,/usr/local/bin/fix-disabled-disk"
    "$SCRIPTS_DIR/immich_jobs/script,/usr/local/bin/immich-jobs"
    "$SCRIPTS_DIR/sd_import/sd-card-import.sh,/usr/local/bin/sd-card-import"
    "$SCRIPTS_DIR/sd_import/immich-go-upload.sh,/usr/local/bin/immich-go-upload"
    "$SCRIPTS_DIR/sd_import/install-sd-import.sh,/usr/local/bin/install-sd-import"
    "$APP_ROOT/vscode-monitor/run.sh,/usr/local/bin/vscode-monitor"
    "$STARTUP_SCRIPT_DIR/bashrc,/root/.bashrc"
    "$STARTUP_SCRIPT_DIR/shell_startup_env.sh,/etc/profile.d/shell_startup_env.sh"
    "$STARTUP_SCRIPT_DIR/auth,/root/.auth"
    "$STARTUP_SCRIPT_DIR/auth/.copilot-token,/root/.copilot-token"
)

for entry in "${SYMLINKS[@]}"; do
    source="${entry%,*}"
    target="${entry#*,}"
    
    if [[ -e "$source" ]]; then
        # Check if target is in a bin directory (needs to be executable)
        if [[ "$target" == */bin/* ]]; then
            # Resolve to canonical path (in case source is via symlink)
            canonical_source="$(readlink -f "$source")"
            # Detect interpreter from shebang
            shebang=$(head -1 "$canonical_source" 2>/dev/null)
            case "$shebang" in
                *python3*|*python*)
                    interpreter="python3" ;;
                *bash*)
                    interpreter="bash" ;;
                *sh*)
                    interpreter="sh" ;;
                *)
                    interpreter="bash" ;;  # default
            esac
            # Create wrapper script (FAT32 boot drive doesn't preserve execute bits)
            rm -f "$target"  # Remove any existing symlink/file
            cat > "$target" << EOF
#!/bin/bash
exec $interpreter "$canonical_source" "\$@"
EOF
            chmod +x "$target"
            echo "  $target -> $canonical_source (wrapper: $interpreter)"
        else
            ln -sf "$source" "$target"
            echo "  $target -> $source"
        fi
    else
        echo "  SKIP: $source (not found)"
    fi
done

# === FIX /etc/profile ===
# Unraid's default profile has 'cd $HOME' which breaks VS Code Remote SSH
echo "Fixing /etc/profile..."
if grep -q '^cd \$HOME$' /etc/profile 2>/dev/null; then
    sed -i '/^cd \$HOME$/d' /etc/profile
    echo "  Removed 'cd \$HOME' from /etc/profile"
else
    echo "  /etc/profile already fixed"
fi

echo ""
echo "=== Shell Startup Complete ==="
echo "Finished: $(date)"
