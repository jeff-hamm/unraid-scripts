#!/bin/bash
#
# Shell Startup Configuration
# Sets up symlinks, bashrc, profile.d, and environment variables
# Run at array startup via User Scripts, or source from /boot/config/go
#

echo "=== Shell Startup Configuration ==="
echo "Started: $(date)"

# Configuration
APP_ROOT="/mnt/pool/appdata"
STARTUP_SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"
SCRIPTS_DIR="$(dirname "$STARTUP_SCRIPT_DIR")"
source ${SCRIPTS_DIR}/.env

git config --global user.email "$GIT_AUTHOR_EMAIL"
git config --global user.name "$GIT_AUTHOR_NAME"
# === SYMLINKS FOR PERSISTENT STORAGE ===
echo "Creating symlinks..."

# Bootstrap pln first (can't use pln to create itself)
cat > /usr/local/bin/pln << 'EOF'
#!/bin/bash
exec bash "/boot/config/plugins/user.scripts/scripts/shell_startup/pln.sh" "$@"
EOF
chmod +x /usr/local/bin/pln
echo "  /usr/local/bin/pln -> pln.sh (wrapper)"

# Use pln to apply all symlinks from config file
pln --apply
# === FIX /etc/profile ===
# Unraid's default profile has 'cd $HOME' which breaks VS Code Remote SSH
echo "Fixing /etc/profile..."
if grep -q '^cd \$HOME$' /etc/profile 2>/dev/null; then
    sed -i '/^cd \$HOME$/d' /etc/profile
    echo "  Removed 'cd \$HOME' from /etc/profile"
else
    echo "  /etc/profile already fixed"
fi

# Increase /var/log tmpfs to 1GB (default 128MB fills up quickly)
current_size=$(df /var/log | awk 'NR==2 {print $2}')
if [[ "$current_size" -lt 1000000 ]]; then
    mount -o remount,size=1G /var/log
    echo "  Increased /var/log to 1GB"
else
    echo "  /var/log already sized appropriately"
fi

echo ""
echo "=== Shell Startup Complete ==="
echo "Finished: $(date)"
